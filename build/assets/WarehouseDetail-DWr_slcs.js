import{ai as xe,J as je,u as ye,r as u,j as e,g as B,s as L,h as $,q as j,C as ge,e as Y,f as E,m as Ce,X as be,B as Te,D as ke,E as we,F as Se,o as K,$ as De,a0 as Ie,a1 as Q,a2 as g,a3 as ve,a4 as C,N as O,Q as V,S as _,T as J,V as X,W as Z,t as T,a as Me,b as Ae,c as Be}from"./index-DAwD_DDx.js";import{W as Le}from"./WarehouseModal-BVHkmdGm.js";const k="https://speedsofttest.com/api",We=()=>{var z;const{id:b}=xe(),{state:N}=je(),w=ye(),[n,P]=u.useState((N==null?void 0:N.warehouse)||null),[R,W]=u.useState([]),[S,ee]=u.useState(""),[F,se]=u.useState([]),[p,m]=u.useState(!1),[re,ae]=u.useState([]),[ne,q]=u.useState(!1),[oe,D]=u.useState(!1),[le,I]=u.useState(!1),[h,v]=u.useState(null),[f,x]=u.useState(""),[y,M]=u.useState(""),te=u.useRef(),d=(s,o="success")=>{const l=Date.now(),r=e.jsxs(Me,{autohide:!0,visible:!0,delay:5e3,className:o==="error"?"bg-danger text-white":"bg-success text-white",children:[e.jsx(Ae,{closeButton:!0,children:e.jsx("strong",{className:"me-auto",children:o==="error"?"Hata":"Başarılı"})}),e.jsx(Be,{children:s})]},l);return ae(a=>[...Array.isArray(a)?a:[],r]),l},ie=async s=>{var o,l,r;try{if(m(!0),console.log("Fetching warehouse with ID:",s),!s||isNaN(s))throw new Error("Geçersiz depo ID'si.");const{data:a}=await T.get(`${k}depo/get-by-id/${s}`);if(console.log("Warehouse API response:",a),!a||a.durumu!==1)throw new Error("Depo bulunamadı veya aktif değil.");P({id:a.id,adi:a.adi||"Bilinmeyen Depo"}),await H(a.id)}catch(a){console.error("Depo yükleme hatası:",((o=a.response)==null?void 0:o.data)||a.message),d(((r=(l=a.response)==null?void 0:l.data)==null?void 0:r.message)||"Depo yüklenemedi.","error"),w("/app/warehouses")}finally{m(!1)}},de=async()=>{var s,o,l;try{const{data:r}=await T.get(`${k}/depo/get-all`);console.log("Warehouses API response:",r);const a=Array.isArray(r)?r.filter(t=>t.durumu===1&&t.id!==parseInt((n==null?void 0:n.id)||b)):(r==null?void 0:r.durumu)===1&&r.id!==parseInt((n==null?void 0:n.id)||b)?[r]:[];se(a)}catch(r){console.error("Depolar yükleme hatası:",((s=r.response)==null?void 0:s.data)||r.message),d(((l=(o=r.response)==null?void 0:o.data)==null?void 0:l.message)||"Depolar yüklenemedi.","error")}},H=async s=>{var o,l,r,a;try{m(!0),console.log("Fetching products for depoId:",s);const{data:t}=await T.get(`${k}/depo/depolardaki-urunstoklar/${s}`);if(console.log("Stock API response:",t),!Array.isArray(t))throw new Error("Stok verisi dizi formatında değil.");const A=t.filter(c=>c.durumu===1);console.log("Active stocks:",A);const U=A.map(c=>{var G;try{const i=c.urun;return console.log(`Product data for urunId ${c.urunId}:`,i),{id:c.id,code:(i==null?void 0:i.urunKodu)||"Bilinmeyen Kod",barcode:(i==null?void 0:i.barkod)||"Bilinmeyen Barkod",brand:((G=i==null?void 0:i.urunMarka)==null?void 0:G.adi)||"Bilinmeyen Marka",name:(i==null?void 0:i.adi)||"Bilinmeyen Ürün",quantity:c.miktar??0,value:(c.fiyat??0)*(c.miktar??0),unitCost:c.fiyat??0,urunId:c.urunId,depoId:c.depoId}}catch(i){return console.error(`Ürün ID ${c.urunId} için hata:`,i.message),null}}).filter(c=>c!==null);console.log("Fetched products:",U),W(U)}catch(t){console.error("Ürün yükleme hatası:",((o=t.response)==null?void 0:o.data)||t.message);const A=((l=t.response)==null?void 0:l.status)===404?"Stok verileri için endpoint bulunamadı.":((a=(r=t.response)==null?void 0:r.data)==null?void 0:a.message)||"Ürünler yüklenemedi.";d(A,"error")}finally{m(!1)}},ce=async()=>{var s,o,l;if(!f){d("Lütfen hedef depo seçin.","error");return}try{m(!0),await T.post(`${k}/depo/depo-tumurunleri-aktar/${n.id}/${f}`),d("Tüm ürünler başarıyla transfer edildi.","success"),W([]),D(!1),x("")}catch(r){console.error("Transfer hatası:",((s=r.response)==null?void 0:s.data)||r.message),d(((l=(o=r.response)==null?void 0:o.data)==null?void 0:l.mesaj)||"Transfer işlemi başarısız.","error")}finally{m(!1)}},ue=async()=>{var s,o,l;if(!f){d("Lütfen hedef depo seçin.","error");return}if(!y||y<=0){d("Lütfen geçerli bir miktar girin.","error");return}if(y>(h==null?void 0:h.quantity)){d("Girilen miktar, mevcut stok miktarını aşıyor.","error");return}try{m(!0);const r={id:h.id,urunId:h.urunId,miktar:parseInt(y)};console.log("Transfer payload:",r),await T.post(`${k}i/depo/secili-urun-aktar/${f}`,r),d("Ürün başarıyla transfer edildi.","success"),W(a=>a.map(t=>t.urunId===h.urunId?{...t,quantity:t.quantity-parseInt(y)}:t).filter(t=>t.quantity>0)),I(!1),v(null),x(""),M("")}catch(r){console.error("Transfer hatası:",((s=r.response)==null?void 0:s.data)||r.message),d(((l=(o=r.response)==null?void 0:o.data)==null?void 0:l.mesaj)||"Transfer işlemi başarısız.","error")}finally{m(!1)}},he=()=>{w(`/app/warehouses/${n.id}/stock-count`,{state:{warehouse:n}})},pe=async s=>{var o,l,r;try{m(!0);const a={id:n.id,adi:s.adi,durumu:1};console.log("Update payload:",a),await T.put(`${k}/depo/update`,a),P(a),q(!1),d("Depo güncellendi.","success")}catch(a){console.error("Depo güncelleme hatası:",((o=a.response)==null?void 0:o.data)||a.message),d(((r=(l=a.response)==null?void 0:l.data)==null?void 0:r.message)||"Depo güncellenemedi.","error")}finally{m(!1)}};u.useEffect(()=>{console.log("useEffect triggered with paramId:",b,"warehouse:",n);const s=(n==null?void 0:n.id)||b;if(!s){console.error("Depo ID'si bulunamadı:",{paramId:b,warehouse:n}),d("Depo ID'si bulunamadı.","error"),w("/app/warehouses");return}!n||n.id!==parseInt(s)?ie(s):H(n.id),de()},[b,n,w]);const me=R.filter(s=>(s.code||"").toLowerCase().includes(S.toLowerCase())||(s.barcode||"").toLowerCase().includes(S.toLowerCase())||(s.brand||"").toLowerCase().includes(S.toLowerCase())||(s.name||"").toLowerCase().includes(S.toLowerCase())),fe=R.reduce((s,o)=>s+(o.value||0),0);return p||!n?e.jsxs(B,{children:[e.jsx(L,{children:"Depo Bilgisi"}),e.jsxs($,{children:[p?e.jsx("p",{children:"Yükleniyor..."}):e.jsx("p",{children:"Depo bulunamadı."}),e.jsx(j,{color:"primary",onClick:()=>w("/app/warehouses"),children:"Geri"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{ref:te,placement:"top-end",className:"p-3",children:re}),e.jsxs(Y,{children:[e.jsx(E,{xs:12,children:e.jsxs(B,{children:[e.jsx(L,{style:{backgroundColor:"#2965A8",color:"#fff",fontSize:"24px"},children:((z=n.adi)==null?void 0:z.toUpperCase())||"DEPO ADI YOK"}),e.jsx($,{children:e.jsx(Y,{children:e.jsx(E,{children:e.jsxs(B,{children:[e.jsx(L,{className:"bg-info",style:{color:"white"},children:"Toplam Stok Değeri"}),e.jsx($,{children:e.jsxs("p",{className:"fw-bold",children:[fe.toLocaleString("tr-TR")," TRY"]})})]})})})})]})}),e.jsx(E,{xs:12,className:"my-3 d-flex",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(j,{color:"primary",style:{color:"white"},onClick:()=>q(!0),children:[e.jsx(Ce,{icon:be})," Güncelle"]}),e.jsx(j,{color:"success",style:{color:"white"},onClick:he,children:"Stok Sayımı Yap"}),e.jsxs(Te,{children:[e.jsx(ke,{color:"info",style:{color:"white"},children:"Depolar Arası Transfer"}),e.jsx(we,{children:e.jsx(Se,{onClick:()=>D(!0),children:"Tamamını Başka Depoya Gönder"})})]})]})}),e.jsx(E,{xs:12,children:e.jsxs(B,{children:[e.jsx(L,{style:{backgroundColor:"#2965A8",color:"white"},children:"Depodaki Ürünler"}),e.jsxs($,{children:[e.jsx(K,{type:"text",placeholder:"Ara...",value:S,onChange:s=>ee(s.target.value),className:"mb-3"}),e.jsxs(De,{responsive:!0,children:[e.jsx(Ie,{children:e.jsxs(Q,{children:[e.jsx(g,{children:"Kod"}),e.jsx(g,{children:"Barkod"}),e.jsx(g,{children:"Marka"}),e.jsx(g,{children:"Ürün"}),e.jsx(g,{children:"Miktar"}),e.jsx(g,{children:"Değeri (TL)"}),e.jsx(g,{children:"Transfer"})]})}),e.jsx(ve,{children:me.map(s=>e.jsxs(Q,{children:[e.jsx(C,{children:s.code}),e.jsx(C,{children:s.barcode}),e.jsx(C,{children:s.brand}),e.jsx(C,{children:s.name}),e.jsx(C,{children:s.quantity}),e.jsxs(C,{children:[s.value.toLocaleString("tr-TR")," TRY"]}),e.jsx(C,{children:e.jsx(j,{color:"info",size:"sm",style:{color:"white"},onClick:()=>{v(s),I(!0)},disabled:p,children:"Transfer"})})]},s.id))})]})]})]})})]}),e.jsxs(O,{visible:oe,onClose:()=>{D(!1),x("")},backdrop:"static",children:[e.jsx(V,{children:e.jsx(_,{children:"Tüm Ürünleri Transfer Et"})}),e.jsx(J,{children:e.jsxs(X,{label:"Hedef Depo",value:f,onChange:s=>x(s.target.value),disabled:p,children:[e.jsx("option",{value:"",children:"Depo Seçin"}),F.map(s=>e.jsx("option",{value:s.id,children:s.adi||"Bilinmeyen Depo"},s.id))]})}),e.jsxs(Z,{children:[e.jsx(j,{color:"primary",onClick:ce,disabled:p||!f,children:"Transfer Et"}),e.jsx(j,{color:"secondary",onClick:()=>{D(!1),x("")},disabled:p,children:"İptal"})]})]}),e.jsxs(O,{visible:le,onClose:()=>{I(!1),v(null),x(""),M("")},backdrop:"static",children:[e.jsx(V,{children:e.jsx(_,{children:h?`${h.name} Ürününü Transfer Et`:"Ürün Transferi"})}),e.jsxs(J,{children:[h&&e.jsxs("p",{children:["Mevcut Miktar: ",e.jsx("strong",{children:h.quantity})]}),e.jsxs(X,{label:"Hedef Depo",value:f,onChange:s=>x(s.target.value),disabled:p,className:"mb-3",children:[e.jsx("option",{value:"",children:"Depo Seçin"}),F.map(s=>e.jsx("option",{value:s.id,children:s.adi||"Bilinmeyen Depo"},s.id))]}),e.jsx(K,{type:"number",label:"Transfer Miktarı",value:y,onChange:s=>M(s.target.value),min:"1",max:h==null?void 0:h.quantity,disabled:p,required:!0})]}),e.jsxs(Z,{children:[e.jsx(j,{color:"primary",onClick:ue,disabled:p||!f||!y,children:"Transfer Et"}),e.jsx(j,{color:"secondary",onClick:()=>{I(!1),v(null),x(""),M("")},disabled:p,children:"İptal"})]})]}),e.jsx(Le,{visible:ne,onClose:()=>q(!1),onSubmit:pe,loading:p,warehouse:n})]})};export{We as default};
