import{r as m,Z as h,j as i,g as ie,s as oe,h as le,e as se,f as p,U as S,o as A,V as x,aI as de,t as j,aB as ce}from"./index-DAwD_DDx.js";import{R as me}from"./ReportForm-C3lYwj_n.js";const Y="https://speedsofttest.com/api",ue={Ç:"C",ç:"c",Ğ:"G",ğ:"g",İ:"I",ı:"i",Ö:"O",ö:"o",Ş:"S",ş:"s",Ü:"U",ü:"u"},e=n=>n&&n.replace(/[ÇçĞğİıÖöŞşÜü]/g,u=>ue[u]||u),he=n=>{try{n.setFont("times","normal")}catch(u){console.error("Font ayarlama hatası:",u),n.setFont("helvetica","normal")}},ge=[{id:1,adi:"Online"},{id:2,adi:"Fiziksel Mağaza"},{id:3,adi:"Bayi"},{id:4,adi:"Telefon Satışı"},{id:5,adi:"Diğer"}],be=()=>{const[n,u]=m.useState({dateRangeStart:h(),dateRangeEnd:h(),customer:"",productService:"",salesChannel:"",comparePeriod:""}),[pe,L]=m.useState([]),[Se,N]=m.useState([]),[O,K]=m.useState([]),[W,H]=m.useState([]),[fe,T]=m.useState(!1),[R,C]=m.useState(null),[G,M]=m.useState(!1),y=r=>{const{name:a,value:l}=r.target;u(d=>({...d,[a]:l})),console.log(`Form data updated: ${a} = ${l}`)},P=(r,a)=>{u(l=>({...l,[r]:a})),console.log(`Date updated: ${r} = ${a.format("YYYY-MM-DD")}`)},w=async(r=!1)=>{try{T(!0),C(null);let l=(await j.get(`${Y}/musteriSatis/musteriSatis-get-all`,{headers:{"Cache-Control":"no-cache"}})).data;if(n.dateRangeStart&&n.dateRangeEnd){const d=r?n.dateRangeStart.subtract(1,n.comparePeriod||"month"):n.dateRangeStart,g=r?n.dateRangeEnd.subtract(1,n.comparePeriod||"month"):n.dateRangeEnd;l=l.filter(D=>{const k=h(D.eklenmeTarihi);return k.isAfter(d.subtract(1,"day"))&&k.isBefore(g.add(1,"day"))})}return l=l.filter(d=>{var g;return(!n.customer||((g=d.musteri)==null?void 0:g.unvani)===n.customer)&&(!n.productService||d.urunAdi===n.productService)&&(!n.salesChannel||(d.kanal||"Diğer")===n.salesChannel)}),console.log(`Filtered sales data (${r?"previous":"current"}):`,l),r?N(l):L(l),l}catch(a){return C("Satış verileri yüklenirken bir hata oluştu."),console.error("Error fetching sales data:",a),[]}finally{T(!1)}},U=async()=>{try{const r=await j.get(`${Y}/musteri/musteri-get-all`);return K(r.data),console.log("Customers fetched:",r.data),r.data}catch(r){return console.error("Müşteriler yüklenirken hata:",r),[]}},I=async()=>{try{const r=await j.get(`${Y}/urun/urun-get-all`);return H(r.data),console.log("Products fetched:",r.data),r.data}catch(r){return console.error("Ürünler yüklenirken hata:",r),[]}};m.useEffect(()=>{(async()=>{try{await Promise.all([U(),I()])}catch(a){console.error("Veri yükleme hatası:",a)}})()},[]);const _=async()=>{var r;M(!0);try{const a=new ce({orientation:"landscape",unit:"mm",format:"a4"});he(a);const l=await w(),d=n.comparePeriod?await w(!0):[];a.setFontSize(18);const g=e("Basit Satış Raporu");a.text(g,a.internal.pageSize.width/2,15,{align:"center"});const D=h().format("DD/MM/YYYY HH:mm:ss");a.setFontSize(10),a.text(e(`Oluşturulma Tarihi: ${D}`),a.internal.pageSize.width/2,25,{align:"center"}),a.text(e(`Rapor Aralığı: ${n.dateRangeStart.format("DD/MM/YYYY")} - ${n.dateRangeEnd.format("DD/MM/YYYY")}`),a.internal.pageSize.width/2,35,{align:"center"}),a.setFontSize(14),a.text(e("Detaylı Satış Verileri"),14,45);const k=l.map(t=>{var o;return[t.id,e(((o=t.musteri)==null?void 0:o.unvani)||"Bilinmeyen Müşteri"),e(t.urunAdi),e(t.kategori||"Bilinmeyen Kategori"),t.miktar,t.birim,`${t.fiyat.toLocaleString("tr-TR")} ₺`,`${t.toplamFiyat.toLocaleString("tr-TR")} ₺`,e(t.kanal||"Diğer"),h(t.eklenmeTarihi).format("DD/MM/YYYY HH:mm")]});a.autoTable({startY:50,head:[[e("ID"),e("Müşteri"),e("Ürün"),e("Kategori"),e("Miktar"),e("Birim"),e("Birim Fiyat"),e("Toplam Fiyat"),e("Satış Kanalı"),e("Tarih")]],body:k,theme:"grid",headStyles:{fillColor:[41,101,168],fontStyle:"bold",textColor:[255,255,255]},styles:{font:"times",fontStyle:"normal",cellPadding:3,fontSize:8,overflow:"linebreak"},margin:{top:50,right:14,bottom:30,left:14},tableWidth:"auto"});let s=a.autoTable.previous.finalY+15;s>a.internal.pageSize.height-50&&(a.addPage(),s=20),a.setFontSize(14),a.text(e("Ürün/Kategori Bazında Satış Özeti"),14,s);const q=l.reduce((t,o)=>{const c=o.urunAdi;return t[c]||(t[c]={miktar:0,toplamFiyat:0,kategori:o.kategori||"Bilinmeyen"}),t[c].miktar+=o.miktar,t[c].toplamFiyat+=o.toplamFiyat,t},{}),Q=Object.entries(q).map(([t,o])=>[e(t),e(o.kategori),o.miktar,`${o.toplamFiyat.toLocaleString("tr-TR")} ₺`]);a.autoTable({startY:s+5,head:[[e("Ürün"),e("Kategori"),e("Toplam Miktar"),e("Toplam Fiyat")]],body:Q,theme:"grid",headStyles:{fillColor:[41,101,168],fontStyle:"bold",textColor:[255,255,255]},styles:{font:"times",fontStyle:"normal",cellPadding:3,fontSize:10,overflow:"linebreak"},margin:{left:14},tableWidth:"auto"}),s=a.autoTable.previous.finalY+15,s>a.internal.pageSize.height-50&&(a.addPage(),s=20),a.setFontSize(14),a.text(e("Satış Kanalı Bazında Özet"),14,s);const $=l.reduce((t,o)=>{const c=o.kanal||"Diğer";return t[c]||(t[c]={miktar:0,toplamFiyat:0}),t[c].miktar+=o.miktar,t[c].toplamFiyat+=o.toplamFiyat,t},{}),Z=Object.entries($).map(([t,o])=>[e(t),o.miktar,`${o.toplamFiyat.toLocaleString("tr-TR")} ₺`]);a.autoTable({startY:s+5,head:[[e("Satış Kanalı"),e("Toplam Miktar"),e("Toplam Fiyat")]],body:Z,theme:"grid",headStyles:{fillColor:[41,101,168],fontStyle:"bold",textColor:[255,255,255]},styles:{font:"times",fontStyle:"normal",cellPadding:3,fontSize:10,overflow:"linebreak"},margin:{left:14},tableWidth:"auto"}),s=a.autoTable.previous.finalY+15,s>a.internal.pageSize.height-50&&(a.addPage(),s=20),a.setFontSize(14),a.text(e("Genel Özet ve Performans Göstergeleri"),14,s);const f=l.reduce((t,o)=>t+o.toplamFiyat,0),E=l.reduce((t,o)=>t+o.miktar,0),J=l.length>0?f/l.length:0,v=l.length,X=v>0?f/v:0,B=new Set(l.map(t=>{var o;return(o=t.musteri)==null?void 0:o.unvani})).size,ee=new Set(l.map(t=>t.urunAdi)).size,z=d.reduce((t,o)=>t+o.toplamFiyat,0),b=z>0?(f-z)/z*100:0,F=t=>t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})+" ₺",ae=[[e("Toplam Satış Tutarı"),F(f)],[e("Toplam Satış Miktarı"),`${E} adet`],[e("Ortalama Satış Tutarı"),F(J)],[e("Toplam Satış Sayısı"),`${v} adet`],[e("Ortalama Sepet Tutarı"),F(X)],[e("Eşsiz Müşteri Sayısı"),`${B} adet`],[e("Eşsiz Ürün Sayısı"),`${ee} adet`],n.comparePeriod&&[e("Değişim (Önceki Dönem)"),`${b.toFixed(2)}%`]].filter(Boolean);a.autoTable({startY:s+5,body:ae,theme:"grid",headStyles:{fillColor:[41,101,168],fontStyle:"bold",textColor:[255,255,255]},styles:{font:"times",fontStyle:"normal",cellPadding:3,fontSize:10,overflow:"linebreak"},columnStyles:{0:{fontStyle:"bold",cellWidth:80},1:{cellWidth:60}},margin:{left:14},tableWidth:140}),s=a.autoTable.previous.finalY+15,s>a.internal.pageSize.height-50&&(a.addPage(),s=20),a.setFontSize(14),a.text(e("Değerlendirme ve Öneriler"),14,s);const te=[b>0?"Satışlar önceki döneme göre % "+b.toFixed(2)+" arttı. Başarılı stratejilere devam edin, yeni fırsatlar araştırın.":"Satışlar önceki döneme göre % "+Math.abs(b).toFixed(2)+" düştü. Nedenleri analiz edin ve pazarlama kampanyalarını güçlendirin.",E>d.reduce((t,o)=>t+o.miktar,0)?"Satış miktarı artmış. Stok yönetimini optimize edin.":"Satış miktarı azalmış. Ürün çeşitliliğini gözden geçirin.",n.salesChannel?`Seçilen satış kanalı (${n.salesChannel}) toplam satışların %${((((r=$[n.salesChannel])==null?void 0:r.toplamFiyat)||0)/f*100).toFixed(2)}'ini oluşturuyor. Bu kanala odaklanın.`:"Tüm satış kanallarında dengeli bir dağılım var. En zayıf kanalı güçlendirin.",B<10?"Müşteri sayısı düşük. Yeni müşteri kazanma stratejileri uygulayın.":"Müşteri tabanı geniş. Sadakat programları geliştirin.","Genel öneri: Dijital pazarlama ve veri analizi araçlarını kullanarak trendleri takip edin."];a.autoTable({startY:s+5,body:te.map((t,o)=>[o+1,e(t)]),theme:"grid",head:[[e("No"),e("Öneri / Değerlendirme")]],headStyles:{fillColor:[41,101,168],fontStyle:"bold",textColor:[255,255,255]},styles:{font:"times",fontStyle:"normal",cellPadding:3,fontSize:10,overflow:"linebreak"},columnStyles:{0:{cellWidth:20},1:{cellWidth:"auto"}},margin:{left:14},tableWidth:"auto"});const re=a.output("blob"),ne=URL.createObjectURL(re);window.open(ne,"_blank")}catch(a){C("PDF oluşturulurken bir hata oluştu."),console.error("Error generating PDF:",a)}finally{M(!1)}},V=async()=>{console.log("Form submitted with data:",n),await _()};return i.jsxs(ie,{children:[i.jsx(oe,{style:{backgroundColor:"#2965A8",color:"#fff"},children:e("Satış Raporu")}),i.jsx(le,{children:i.jsxs(me,{onSubmit:V,pdfLoading:G,children:[i.jsxs(se,{children:[i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Başlangıç Tarihi")}),i.jsx(A,{type:"date",value:n.dateRangeStart.format("YYYY-MM-DD"),onChange:r=>P("dateRangeStart",h(r.target.value)),className:"mb-3"})]}),i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Bitiş Tarihi")}),i.jsx(A,{type:"date",value:n.dateRangeEnd.format("YYYY-MM-DD"),onChange:r=>P("dateRangeEnd",h(r.target.value)),className:"mb-3"})]}),i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Müşteri")}),i.jsxs(x,{name:"customer",value:n.customer,onChange:y,className:"mb-3",children:[i.jsx("option",{value:"",children:e("Seçiniz")}),O.map(r=>i.jsx("option",{value:r.unvani,children:e(r.unvani)},r.id))]})]}),i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Ürün / Hizmet")}),i.jsxs(x,{name:"productService",value:n.productService,onChange:y,className:"mb-3",children:[i.jsx("option",{value:"",children:e("Seçiniz")}),W.map(r=>i.jsx("option",{value:r.adi,children:e(r.adi)},r.id))]})]}),i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Satış Kanalı")}),i.jsxs(x,{name:"salesChannel",value:n.salesChannel,onChange:y,className:"mb-3",children:[i.jsx("option",{value:"",children:e("Seçiniz")}),ge.map(r=>i.jsx("option",{value:r.adi,children:e(r.adi)},r.id))]})]}),i.jsxs(p,{md:6,children:[i.jsx(S,{children:e("Karşılaştırma Dönemi")}),i.jsxs(x,{name:"comparePeriod",value:n.comparePeriod,onChange:y,className:"mb-3",children:[i.jsx("option",{value:"",children:e("Seçiniz")}),i.jsx("option",{value:"month",children:e("Geçen Ay")}),i.jsx("option",{value:"year",children:e("Geçen Yıl")})]})]})]}),R&&i.jsx(de,{color:"danger",className:"mb-3",children:R})]})})]})};export{be as default};
